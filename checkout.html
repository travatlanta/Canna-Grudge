<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Checkout â€¢ CannaGrudge</title>
  <link rel="stylesheet" href="theme.css">
  <script type="text/javascript" src="https://web.squarecdn.com/v1/square.js"></script>
  <style>
    .checkout-grid {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 32px;
      margin-top: 40px;
    }
    @media (max-width: 768px) {
      .checkout-grid {
        grid-template-columns: 1fr;
      }
    }
    .payment-form, .order-summary {
      background: var(--cg-surface);
      border: 1px solid var(--cg-border);
      border-radius: var(--cg-radius-lg);
      padding: 28px 24px;
    }
    .payment-form h3, .order-summary h3 {
      font-family: var(--cg-font-display);
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    #card-container {
      min-height: 90px;
      margin-bottom: 20px;
    }
    .payment-error {
      color: var(--cg-red);
      font-size: 14px;
      margin-top: 12px;
      display: none;
    }
    .payment-processing {
      display: none;
      text-align: center;
      padding: 16px;
      color: var(--cg-text-secondary);
    }
    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
    }
    .item-name {
      color: var(--cg-text-secondary);
      font-size: 14px;
    }
    .item-price {
      font-weight: 700;
      color: var(--cg-text);
    }
    .order-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: var(--cg-font-display);
    }
    .total-label {
      font-size: 16px;
      font-weight: 600;
      color: var(--cg-text-secondary);
    }
    .total-amount {
      font-size: 24px;
      font-weight: 900;
      color: var(--cg-gold);
    }
    .promo-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .promo-row .input {
      flex: 1;
    }
    #promoStatus {
      font-size: 13px;
      margin-top: 6px;
      min-height: 18px;
    }
    .discount-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 14px;
      color: var(--cg-green);
    }
  </style>
</head>
<body class="page-padded">

  <div class="page-header">
    <div class="container">
      <h1>Checkout</h1>
      <p class="section-subtitle">Complete your ticket purchase</p>
    </div>
  </div>

  <section class="section">
    <div class="container">
      <div class="checkout-grid">
        <div class="payment-form">
          <h3>Payment Details</h3>
          <div class="form-group">
            <label class="label" for="emailInput">Email Address</label>
            <input type="email" class="input" id="emailInput" placeholder="you@example.com">
          </div>
          <div class="form-group">
            <label class="label" for="nameInput">Full Name</label>
            <input type="text" class="input" id="nameInput" placeholder="Your full name">
          </div>
          <div class="form-group">
            <label class="label" for="promoInput">Promo Code (optional)</label>
            <div class="promo-row">
              <input type="text" class="input" id="promoInput" placeholder="Enter promo code">
              <button class="btn btn-outline btn-sm" id="applyPromo">Apply</button>
            </div>
            <div id="promoStatus"></div>
          </div>
          <div id="card-container"></div>
          <button class="btn btn-primary btn-block btn-lg" id="payBtn" disabled>Pay Now</button>
          <div class="payment-error" id="paymentError"></div>
          <div class="payment-processing" id="paymentProcessing">Processing your payment...</div>
        </div>
        <div class="order-summary">
          <h3>Order Summary</h3>
          <div id="orderItems"></div>
          <div id="discountLine"></div>
          <div class="divider"></div>
          <div class="order-total">
            <span class="total-label">Total</span>
            <span class="total-amount" id="orderTotal">$0.00</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <footer class="footer" data-animate="fade">
    <div class="container">
      <div class="footer-grid">
        <div class="footer-col">
          <div class="footer-brand">Canna<span>Grudge</span></div>
          <p class="footer-desc">The ultimate cannabis boxing event. Live fights, music, vendors, and more in Litchfield Park, AZ.</p>
          <div class="footer-social">
            <a href="https://www.instagram.com/" target="_blank" aria-label="Instagram"><img src="assets/Icons/instagram.png" alt="Instagram"></a>
            <a href="https://www.facebook.com/" target="_blank" aria-label="Facebook"><img src="assets/Icons/facebook.png" alt="Facebook"></a>
            <a href="https://twitter.com/" target="_blank" aria-label="X"><img src="assets/Icons/twitter.png" alt="X"></a>
          </div>
        </div>
        <div class="footer-col">
          <h4>Event</h4>
          <a href="index.html">Home</a>
          <a href="event.html">Event Info</a>
          <a href="sponsors.html">Sponsors</a>
          <a href="tickets.html">Tickets</a>
        </div>
        <div class="footer-col">
          <h4>Support</h4>
          <a href="event.html#faq">FAQ</a>
          <a href="event.html#contact">Contact</a>
          <a href="tos.html">Terms &amp; Conditions</a>
        </div>
        <div class="footer-col">
          <h4>Legal</h4>
          <a href="privacy.html">Privacy Policy</a>
          <a href="delete-data.html">Delete Data</a>
        </div>
      </div>
      <div class="footer-bottom">
        <span>&copy; 2026 CannaGrudge. All rights reserved.</span>
        <div>
          <a href="privacy.html">Privacy</a> &nbsp;&middot;&nbsp; <a href="tos.html">Terms</a>
        </div>
      </div>
    </div>
  </footer>

  <script src="api-config.js"></script>
  <script src="app.js?v=2"></script>
  <script type="module" src="./firebase-config.js"></script>
  <script>
document.addEventListener('DOMContentLoaded', async () => {
  let cart = typeof getCart === 'function' ? getCart() : JSON.parse(localStorage.getItem('cg_cart') || '[]');

  const params = new URLSearchParams(window.location.search);
  const inviteToken = params.get('invite');

  if (inviteToken) {
    try {
      const invRes = await fetch(window.CG_API_BASE + '/api/purchase-links/' + encodeURIComponent(inviteToken));
      if (invRes.ok) {
        const invData = await invRes.json();
        cart = [{
          id: invData.tier_name.toLowerCase().replace(/\s+/g, '-'),
          name: invData.tier_name,
          price: invData.price_cents,
          qty: invData.qty,
          tierId: invData.tier_id
        }];
        if (typeof saveCart === 'function') saveCart(cart);
        if (invData.email) {
          document.getElementById('emailInput').value = invData.email;
        }
        if (invData.promo_code) {
          document.getElementById('promoInput').value = invData.promo_code;
        }
      }
    } catch (e) {}
  }

  if (cart.length === 0) {
    location.href = 'tickets.html';
    return;
  }

  const itemsEl = document.getElementById('orderItems');
  const totalEl = document.getElementById('orderTotal');
  const discountLineEl = document.getElementById('discountLine');
  let originalTotal = 0;
  let appliedPromoCode = '';
  let appliedDiscount = 0;
  let appliedDiscountType = '';
  let appliedDiscountAmount = 0;

  function renderOrderSummary() {
    originalTotal = 0;
    itemsEl.innerHTML = cart.map(item => {
      const itemTotal = item.price * item.qty;
      originalTotal += itemTotal;
      return '<div class="order-item"><span class="item-name">' + item.name + ' x' + item.qty + '</span><span class="item-price">$' + (itemTotal/100).toFixed(2) + '</span></div>';
    }).join('');

    if (appliedPromoCode && appliedDiscount > 0) {
      discountLineEl.innerHTML = '<div class="discount-line"><span>Discount (' + appliedPromoCode + ')</span><span>-$' + (appliedDiscount/100).toFixed(2) + '</span></div>';
    } else {
      discountLineEl.innerHTML = '';
    }

    const finalTotal = Math.max(0, originalTotal - appliedDiscount);
    totalEl.textContent = '$' + (finalTotal/100).toFixed(2);
  }

  renderOrderSummary();

  function recalcDiscount() {
    if (!appliedPromoCode) {
      appliedDiscount = 0;
      return;
    }
    if (appliedDiscountType === 'percent') {
      appliedDiscount = Math.floor(originalTotal * appliedDiscountAmount / 100);
    } else {
      appliedDiscount = appliedDiscountAmount;
    }
    if (appliedDiscount > originalTotal) appliedDiscount = originalTotal;
  }

  document.getElementById('applyPromo').addEventListener('click', async () => {
    const code = document.getElementById('promoInput').value.trim();
    const statusEl = document.getElementById('promoStatus');

    if (!code) {
      statusEl.style.color = 'var(--cg-red)';
      statusEl.textContent = 'Please enter a promo code';
      return;
    }

    try {
      const res = await fetch(window.CG_API_BASE + '/api/promos/validate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: code })
      });
      const data = await res.json();

      if (res.ok && data.valid) {
        appliedPromoCode = data.code;
        appliedDiscountType = data.discount_type;
        appliedDiscountAmount = data.discount_amount;
        recalcDiscount();
        renderOrderSummary();

        statusEl.style.color = 'var(--cg-green)';
        if (data.discount_type === 'percent') {
          statusEl.textContent = data.discount_amount + '% off applied!';
        } else {
          statusEl.textContent = '$' + (data.discount_amount / 100).toFixed(2) + ' off applied!';
        }
      } else {
        appliedPromoCode = '';
        appliedDiscount = 0;
        renderOrderSummary();
        statusEl.style.color = 'var(--cg-red)';
        statusEl.textContent = data.error || 'Invalid promo code';
      }
    } catch (e) {
      statusEl.style.color = 'var(--cg-red)';
      statusEl.textContent = 'Could not validate promo code';
    }
  });

  if (inviteToken && document.getElementById('promoInput').value) {
    document.getElementById('applyPromo').click();
  }

  try {
    const configRes = await fetch(window.CG_API_BASE + '/api/square-config');
    const config = await configRes.json();

    if (!config.applicationId) {
      document.getElementById('paymentError').textContent = 'Payment system not configured.';
      document.getElementById('paymentError').style.display = 'block';
      return;
    }

    const payments = window.Square.payments(config.applicationId, config.locationId);
    const card = await payments.card();
    await card.attach('#card-container');

    document.getElementById('payBtn').disabled = false;

    document.getElementById('payBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      const email = document.getElementById('emailInput').value.trim();
      const name = document.getElementById('nameInput').value.trim();

      if (!email || !name) {
        document.getElementById('paymentError').textContent = 'Please fill in all fields.';
        document.getElementById('paymentError').style.display = 'block';
        return;
      }

      document.getElementById('payBtn').disabled = true;
      document.getElementById('payBtn').textContent = 'Processing...';
      document.getElementById('paymentError').style.display = 'none';

      try {
        const result = await card.tokenize();
        if (result.status !== 'OK') {
          throw new Error(result.errors?.[0]?.message || 'Card verification failed');
        }

        const payRes = await fetch(window.CG_API_BASE + '/api/create-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourceId: result.token,
            items: cart.map(function(item) { return { id: item.id, name: item.name, price: item.price, qty: item.qty, tierId: item.tierId }; }),
            email: email,
            name: name,
            promoCode: appliedPromoCode || ''
          })
        });

        const payData = await payRes.json();

        if (payData.success) {
          localStorage.setItem('cg_last_order', JSON.stringify({
            items: cart,
            total: originalTotal,
            discount: payData.discount || 0,
            email: email,
            name: name,
            paymentId: payData.payment.id,
            orderId: payData.order_id,
            promoCode: appliedPromoCode || '',
            receiptUrl: payData.payment.receipt_url || '',
            date: new Date().toISOString()
          }));
          localStorage.removeItem('cg_cart');
          location.href = 'confirmation.html';
        } else {
          throw new Error(payData.errors?.[0]?.detail || 'Payment failed');
        }
      } catch (err) {
        document.getElementById('paymentError').textContent = err.message || 'Payment failed. Please try again.';
        document.getElementById('paymentError').style.display = 'block';
        document.getElementById('payBtn').disabled = false;
        document.getElementById('payBtn').textContent = 'Pay Now';
      }
    });
  } catch (err) {
    document.getElementById('paymentError').textContent = 'Could not load payment form. Please try again.';
    document.getElementById('paymentError').style.display = 'block';
  }
});
  </script>
</body>
</html>
