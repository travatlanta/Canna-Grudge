<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard • CannaGrudge</title>
  <link rel="stylesheet" href="theme.css">
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0;background:#0f1012;color:#eaecef}
    .wrap{max-width:720px;margin:24px auto;padding:16px}
    .card{background:#181b20;border:1px solid #2a2f36;border-radius:16px;padding:16px;box-shadow:0 4px 24px rgba(0,0,0,.28)}
    .muted{opacity:.8}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#fff;color:#111;
         font-weight:800;cursor:pointer}
  </style>
</head>
<body class="with-dock">
  <!-- Use a main container so the bottom nav can compute proper padding -->
  <main class="container">
    <!-- Profile card -->
    <div class="card profile-card" style="max-width:720px;margin:24px auto 8px;padding:16px;">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;">
        <img id="profileImage" src="assets/Icons/avatar-placeholder.png" alt="Profile picture" style="width:64px;height:64px;border-radius:50%;border:2px solid var(--cg-border);object-fit:cover;">
        <div>
          <h1 id="name" style="margin:0 0 4px;">Loading…</h1>
          <div class="muted">Email: <span id="email">—</span></div>
          <div class="muted">Provider: <span id="provider">—</span></div>
        </div>
      </div>
      <div style="margin-bottom:12px;">
        <input type="file" id="profileUpload" accept="image/*" style="display:none">
        <button id="uploadButton" class="btn" type="button">Upload Photo</button>
      </div>
      <div style="margin-top:14px;">
        <button id="logout" class="btn">Sign Out</button>
      </div>
    </div>

    <!-- Tickets card -->
    <div class="card tickets-card" style="max-width:720px;margin:24px auto;padding:16px;">
      <h2 style="margin-top:0;margin-bottom:12px;">My Tickets</h2>
      <div id="ticketsPlaceholder" class="muted" style="margin-bottom:12px;">No tickets purchased yet. Tickets will appear here when available.</div>
      <!-- Download/print button for tickets. Disabled until tickets are available -->
      <button id="downloadTickets" class="btn" type="button" disabled>Download / Print Tickets</button>
    </div>

    <!-- Preferences -->
    <div class="card preferences-card" style="max-width:720px;margin:24px auto;padding:16px;">
      <h2 style="margin-top:0;margin-bottom:12px;">Preferences</h2>
      <div class="muted" style="margin-bottom:8px;">Dashboard Theme</div>
      <select id="themeSelect" class="btn" style="background:#181b20;color:#eaecef;border:1px solid var(--cg-border);padding:6px 8px;margin-bottom:16px;">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="system">System</option>
      </select>
      <div class="muted" style="margin-bottom:8px;">Bio</div>
      <textarea id="bio" rows="3" style="width:100%;border-radius:12px;padding:8px;background:#181b20;color:#eaecef;border:1px solid var(--cg-border);" placeholder="Tell us about yourself"></textarea>
    </div>

    <!-- Notification Settings -->
    <div class="card notifications-card" style="max-width:720px;margin:24px auto;padding:16px;">
      <h2 style="margin-top:0;margin-bottom:12px;">Notification Settings</h2>
      <label style="display:block;margin-bottom:8px;"><input type="checkbox" id="notifPush" /> Push Notifications</label>
      <label style="display:block;margin-bottom:8px;"><input type="checkbox" id="notifEmail" /> Email Notifications</label>
    </div>

    <!-- Wallet & Billing -->
    <div class="card wallet-card" style="max-width:720px;margin:24px auto;padding:16px;">
      <h2 style="margin-top:0;margin-bottom:12px;">Wallet &amp; Billing</h2>
      <div class="muted" style="margin-bottom:8px;">No saved payment methods.</div>
      <div class="muted">No billing history available.</div>
    </div>

    <!-- Message Center -->
    <div class="card message-center-card" style="max-width:720px;margin:24px auto;padding:16px;">
      <h2 style="margin-top:0;margin-bottom:12px;">Message Center</h2>
      <div class="muted" style="margin-bottom:8px;">Send a message to event administrators.</div>
      <textarea id="messageInput" rows="4" style="width:100%;border-radius:12px;padding:8px;background:#181b20;color:#eaecef;border:1px solid var(--cg-border);" placeholder="Type your message here"></textarea>
      <button id="sendMessage" class="btn" type="button" style="margin-top:8px;">Send</button>
    </div>

    <!-- Privacy & Security -->
    <div class="card privacy-card" style="max-width:720px;margin:24px auto;padding:16px;">
      <h2 style="margin-top:0;margin-bottom:12px;">Privacy &amp; Security</h2>
      <label style="display:block;margin-bottom:8px;"><input type="checkbox" id="hideProfile" /> Hide my profile from public</label>
      <label style="display:block;margin-bottom:8px;"><input type="checkbox" id="enable2FA" /> Enable Two-Factor Authentication</label>
    </div>

    <!-- Frequently Asked Questions -->
    <div class="card faq-card" style="max-width:720px;margin:24px auto;padding:16px;">
      <h2 style="margin-top:0;margin-bottom:12px;">Frequently Asked Questions</h2>
      <div class="muted">Coming soon: We'll populate this section with helpful answers to common questions about events, tickets, and your account.</div>
    </div>
  </main>

  <script type="module" src="./firebase-config.js"></script>
  <script type="module">
    const { auth, onAuthStateChanged, signOut } = window.__cgAuth;
    // Elements for profile photo and upload
    const profileImageEl = document.getElementById('profileImage');
    const uploadButton = document.getElementById('uploadButton');
    const profileUpload = document.getElementById('profileUpload');

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        const ret = encodeURIComponent(location.pathname + location.search + location.hash);
        location.href = 'login.html?return=' + ret;
        return;
      }
      const name = user.displayName || 'CannaGrudge User';
      const email = user.email || '—';
      const providerId = (user.providerData[0] && user.providerData[0].providerId) || '—';
      document.getElementById('name').textContent = name;
      document.getElementById('email').textContent = email;
      document.getElementById('provider').textContent = providerId;
      // Set the profile image from the social provider or previously uploaded avatar
      const storedAvatar = localStorage.getItem('avatar');
      const photo = user.photoURL || storedAvatar;
      if (photo) {
        profileImageEl.src = photo;
      }
    });

    document.getElementById('logout').onclick = async () => {
      await signOut(auth);
      location.href = 'login.html';
    };

    // Preferences: load and save theme preference
    const themeSelect = document.getElementById('themeSelect');
    if (themeSelect) {
      // Set initial value based on stored preference or default
      const savedTheme = localStorage.getItem('dashboardTheme') || 'dark';
      themeSelect.value = savedTheme;
      themeSelect.addEventListener('change', () => {
        localStorage.setItem('dashboardTheme', themeSelect.value);
        // Here you could apply the theme to the document or notify the user
      });
    }
    // Bio persistence (optional)
    const bioInput = document.getElementById('bio');
    if (bioInput) {
      bioInput.value = localStorage.getItem('userBio') || '';
      bioInput.addEventListener('blur', () => {
        localStorage.setItem('userBio', bioInput.value);
      });
    }
    // Notification settings persistence
    const notifPush = document.getElementById('notifPush');
    const notifEmail = document.getElementById('notifEmail');
    if (notifPush) {
      notifPush.checked = localStorage.getItem('notifPush') === 'true';
      notifPush.addEventListener('change', () => {
        localStorage.setItem('notifPush', notifPush.checked);
      });
    }
    if (notifEmail) {
      notifEmail.checked = localStorage.getItem('notifEmail') === 'true';
      notifEmail.addEventListener('change', () => {
        localStorage.setItem('notifEmail', notifEmail.checked);
      });
    }
    // Privacy settings persistence
    const hideProfile = document.getElementById('hideProfile');
    const enable2FA = document.getElementById('enable2FA');
    if (hideProfile) {
      hideProfile.checked = localStorage.getItem('hideProfile') === 'true';
      hideProfile.addEventListener('change', () => {
        localStorage.setItem('hideProfile', hideProfile.checked);
      });
    }
    if (enable2FA) {
      enable2FA.checked = localStorage.getItem('enable2FA') === 'true';
      enable2FA.addEventListener('change', () => {
        localStorage.setItem('enable2FA', enable2FA.checked);
      });
    }
    // Handle ticket download/print (stub)
    const downloadBtn = document.getElementById('downloadTickets');
    if (downloadBtn) {
      downloadBtn.addEventListener('click', () => {
        // Currently no tickets available; you could integrate actual tickets here
        alert('There are no tickets available to download or print at this time.');
      });
    }
    // Message center send handler
    const sendMessage = document.getElementById('sendMessage');
    const messageInput = document.getElementById('messageInput');
    if (sendMessage && messageInput) {
      sendMessage.addEventListener('click', () => {
        const msg = messageInput.value.trim();
        if (!msg) return;
        alert('Your message has been sent to the event administrators.');
        messageInput.value = '';
      });
    }

    // Trigger hidden file input when clicking the upload button
    uploadButton.addEventListener('click', () => {
      profileUpload.click();
    });

    // Read the selected image and display it as the user's avatar; store in localStorage
    profileUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        const dataUrl = evt.target.result;
        profileImageEl.src = dataUrl;
        localStorage.setItem('avatar', dataUrl);
      };
      reader.readAsDataURL(file);
    });
  </script>

  <script src="app.js"></script>
  <footer class="footer footer--stack">
    <div class="footer__share"><img src="assets/Icons/share-online.png" alt="Share Online" /></div>
    <div class="footer__icons">
      <a href="https://www.instagram.com/?url=https%3A%2F%2Fcannagrudge.com" target="_blank" data-share="instagram" title="Share on Instagram"><img src="assets/Icons/instagram.png" alt="Instagram" /></a>
      <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fcannagrudge.com" target="_blank" data-share="facebook" title="Share on Facebook"><img src="assets/Icons/facebook.png" alt="Facebook" /></a>
      <a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fcannagrudge.com" target="_blank" data-share="twitter" title="Share on X"><img src="assets/Icons/twitter.png" alt="X" /></a>
      <a href="https://www.snapchat.com/share?link=https%3A%2F%2Fcannagrudge.com" target="_blank" data-share="snapchat" title="Share on Snapchat"><img src="assets/Icons/snapchat.png" alt="Snapchat" /></a>
      <a href="https://www.tiktok.com/" target="_blank" data-share="tiktok" title="Share on TikTok"><img src="assets/Icons/tik tok.png" alt="TikTok" /></a>
    </div>
    <div class="footer__links">
      <a href="event.html#info">Event Info</a>
      <a href="event.html#schedule">Schedule</a>
      <a href="event.html#tickets">Ticket Info</a>
      <a href="event.html#featured">Buy</a>
      <a href="profile.html">Profile</a>
      <a href="tos.html">Terms</a>
      <a href="privacy.html">Privacy</a>
      <a href="index.html">Home</a>
    </div>
    <div class="footer__legal">© CannaGrudge. All rights reserved.</div>
  </footer>
  <nav class="bottom-nav">
    <a href="event.html">Event Info</a>
    <a href="index.html" class="home" aria-label="Home">
      <img src="assets/Icons/home.png" alt="Home" width="22" height="22" />
      <span class="sr-only">Home</span>
    </a>
    <a href="dashboard.html">Dashboard</a>
  </nav>
</body>
</html>
